import React, { useState, useEffect, useRef } from 'react';
import { 
  MessageSquare, 
  Search, 
  Library, 
  Settings, 
  Play, 
  CheckCircle, 
  Clock, 
  BarChart2, 
  ChevronDown, 
  ChevronUp, 
  Copy, 
  Heart, 
  Share2, 
  Cpu, 
  Zap, 
  RefreshCw,
  Trash2,
  Moon,
  Sun,
  Globe,
  Database,
  ArrowRight,
  Sparkles,
  BookOpen,
  User,
  LogOut,
  Shield,
  Wifi,
  WifiOff,
  Activity,
  Plus,
  PenTool,
  Check,
  MoreHorizontal,
  Layout,
  List
} from 'lucide-react';

/**
 * ------------------------------------------------------------------
 * æ¨¡æ‹Ÿæ•°æ® (Mock Data)
 * ------------------------------------------------------------------
 */
const MOCK_TED_TALKS = [
  {
    id: 1,
    title: "Why AI needs a sense of ethics",
    speaker: "Technologist X",
    duration: "12:45",
    views: "2.1M",
    description: "An insightful look into how we can program morality into machines...",
    thumbnail: "bg-blue-100 dark:bg-blue-900/30"
  },
  {
    id: 2,
    title: "The future of leadership in the digital age",
    speaker: "Leader Y",
    duration: "15:20",
    views: "1.5M",
    description: "What does it mean to lead when your team is half human, half algorithm?",
    thumbnail: "bg-indigo-100 dark:bg-indigo-900/30"
  },
  {
    id: 3,
    title: "How to learn a new language by 2025",
    speaker: "Linguist Z",
    duration: "09:30",
    views: "5.8M",
    description: "New techniques in cognitive science reveal the secrets of rapid acquisition.",
    thumbnail: "bg-purple-100 dark:bg-purple-900/30"
  },
  {
    id: 4,
    title: "Creative thinking in a data-driven world",
    speaker: "Artist A",
    duration: "18:10",
    views: "900K",
    description: "Why human creativity is becoming more valuable, not less.",
    thumbnail: "bg-pink-100 dark:bg-pink-900/30"
  }
];

// å½±å­å†™ä½œçš„å…·ä½“ç»ƒä¹ å†…å®¹æ•°æ®
const MOCK_SHADOW_CONTENT = {
  1: [ // Talk ID 1 çš„å†…å®¹
    {
      id: 101,
      original: "Leadership requires vision to navigate uncertainty.",
      mimic: "Management demands insight to handle ambiguity.",
      mapping: [
        { from: "Leadership", to: "Management" },
        { from: "requires", to: "demands" },
        { from: "vision", to: "insight" },
        { from: "navigate", to: "handle" }
      ]
    },
    {
      id: 102,
      original: "We must embrace the challenges of the future.",
      mimic: "We should accept the difficulties of tomorrow.",
      mapping: [
        { from: "must", to: "should" },
        { from: "embrace", to: "accept" },
        { from: "challenges", to: "difficulties" }
      ]
    }
  ],
  2: [ // Talk ID 2 çš„å†…å®¹
    {
      id: 201,
      original: "To learn is to change.",
      mimic: "To acquire knowledge is to transform.",
      mapping: [
        { from: "learn", to: "acquire knowledge" },
        { from: "change", to: "transform" }
      ]
    }
  ]
};

// å†å²è®°å½•æ•°æ®
const MOCK_HISTORY = [
  { id: 1, talkId: 1, title: "Why AI needs a sense of ethics", status: 'completed', progress: 100, lastPlayed: '2h ago' },
  { id: 2, talkId: 2, title: "The future of leadership", status: 'in_progress', progress: 45, lastPlayed: '1d ago' },
  { id: 3, talkId: 3, title: "How to learn a new language", status: 'todo', progress: 0, lastPlayed: 'Added today' },
  { id: 4, talkId: 4, title: "Creative thinking", status: 'todo', progress: 0, lastPlayed: 'Added yesterday' },
];

/**
 * ------------------------------------------------------------------
 * åŸºç¡€ç»„ä»¶ (Base Components)
 * ------------------------------------------------------------------
 */

// ç™»å½•é¡µé¢
const LoginPage = ({ onLogin, onGuest }) => {
  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden p-8 space-y-8 animate-in fade-in zoom-in duration-500">
        <div className="text-center">
          <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-200">
            <Sparkles size={32} className="text-white" />
          </div>
          <h1 className="text-3xl font-extrabold text-slate-900 tracking-tight mb-2">Shadow<span className="text-indigo-600">Writer</span></h1>
          <p className="text-slate-500">æŒæ¡åƒ TED æ¼”è®²è€…ä¸€æ ·çš„è‹±è¯­è¡¨è¾¾</p>
        </div>

        <div className="space-y-4">
          <button 
            onClick={() => onLogin('user')}
            className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
          >
            <User size={20} />
            <span>ç™»å½•è´¦å·</span>
          </button>
          
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t border-slate-200"></span>
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-white px-2 text-slate-400">æˆ–è€…</span>
            </div>
          </div>

          <button 
            onClick={() => onGuest()}
            className="w-full bg-indigo-50 text-indigo-700 font-bold py-4 rounded-xl hover:bg-indigo-100 transition-all flex items-center justify-center gap-2 border border-indigo-100"
          >
            <Zap size={20} />
            <span>å…ç™»å½•è¯•ç”¨ (Guest Mode)</span>
          </button>
        </div>

        <p className="text-center text-xs text-slate-400">
          ç‚¹å‡»ç™»å½•å³ä»£è¡¨æ‚¨åŒæ„æˆ‘ä»¬çš„ <a href="#" className="underline hover:text-indigo-600">æœåŠ¡æ¡æ¬¾</a> å’Œ <a href="#" className="underline hover:text-indigo-600">éšç§æ”¿ç­–</a>
        </p>
      </div>
    </div>
  );
};

// å¯¼èˆªæ 
const Navigation = ({ activeTab, setActiveTab, userMode, onLogout }) => {
  const menuItems = [
    { id: 'chat', icon: MessageSquare, label: 'AI åˆ›ä½œ' },
    { id: 'history', icon: Library, label: 'å­¦ä¹ è®°å½•' },
    { id: 'stats', icon: BarChart2, label: 'æ•°æ®ç»Ÿè®¡' },
    { id: 'settings', icon: Settings, label: 'ç³»ç»Ÿè®¾ç½®' },
  ];

  return (
    <>
      {/* Desktop Sidebar */}
      <nav 
        className="hidden md:flex w-20 lg:w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex-col h-screen flex-shrink-0 transition-all duration-300 z-50"
        aria-label="Main Navigation"
      >
        <div className="p-6 flex items-center justify-center lg:justify-start gap-3">
          <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-md shadow-indigo-500/20">
            <Sparkles size={20} className="text-white" />
          </div>
          <span className="font-bold text-xl hidden lg:block tracking-tight text-slate-900 dark:text-white">
            Shadow<span className="text-indigo-600">Writer</span>
          </span>
        </div>
        
        <div className="flex-1 mt-6 px-4 space-y-2">
          {menuItems.map((item) => (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className={`w-full flex items-center gap-3 p-3.5 rounded-xl transition-all duration-200 group ${
                activeTab === item.id 
                  ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/30' 
                  : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white'
              }`}
            >
              <item.icon size={22} className={activeTab === item.id ? 'animate-pulse-slow' : 'group-hover:scale-110 transition-transform'} />
              <span className="hidden lg:block font-medium">{item.label}</span>
            </button>
          ))}
        </div>

        <div className="p-4 border-t border-slate-100 dark:border-slate-800">
          <div className="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer group">
            <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-sm font-bold text-white shadow-sm">
              {userMode === 'guest' ? 'G' : 'JD'}
            </div>
            <div className="hidden lg:block flex-1 min-w-0">
              <p className="text-sm font-bold text-slate-900 dark:text-white truncate">
                {userMode === 'guest' ? 'Guest User' : 'John Doe'}
              </p>
              <p className="text-xs text-slate-500 dark:text-slate-400 truncate">
                {userMode === 'guest' ? 'Trial Version' : 'Premium Member'}
              </p>
            </div>
            <button 
              onClick={onLogout}
              className="hidden lg:block p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
            >
              <LogOut size={16} />
            </button>
          </div>
        </div>
      </nav>

      {/* Mobile Bottom Navigation */}
      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 pb-safe z-50 flex justify-around p-3">
        {menuItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-colors ${
              activeTab === item.id 
                ? 'text-indigo-600 dark:text-indigo-400' 
                : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'
            }`}
          >
            <item.icon size={24} strokeWidth={activeTab === item.id ? 2.5 : 2} />
            <span className="text-[10px] font-medium">{item.label}</span>
          </button>
        ))}
      </nav>
    </>
  );
};

/**
 * ------------------------------------------------------------------
 * å½±å­å†™ä½œæ ¸å¿ƒç»„ä»¶ (Learning Components)
 * ------------------------------------------------------------------
 */

// å­¦ä¹ å¡ç‰‡ - åŒ…å«åŸæ–‡ã€æ¨¡ä»¿ã€ç”¨æˆ·ç»ƒä¹ 
const LearningCard = ({ data }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [userInputs, setUserInputs] = useState(['']); // ç”¨æˆ·å¡«å†™çš„å¥å­åˆ—è¡¨

  // æ·»åŠ æ–°çš„è¾“å…¥æ¡†
  const handleAddInput = () => {
    setUserInputs([...userInputs, '']);
  };

  // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
  const handleInputChange = (index, value) => {
    const newInputs = [...userInputs];
    newInputs[index] = value;
    setUserInputs(newInputs);
  };

  return (
    <section className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6 shadow-sm hover:shadow-md transition-all duration-300 group">
      {/* 1. Original Sentence (Immersive Header) */}
      <div className="p-6 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700">
        <div className="flex items-center gap-2 mb-2">
          <span className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">Original</span>
        </div>
        <p className="text-xl sm:text-2xl font-serif text-slate-800 dark:text-slate-100 leading-relaxed italic">
          "{data.original}"
        </p>
      </div>

      {/* 2. AI Mimic (Reference) */}
      <div className="p-6 border-b border-slate-100 dark:border-slate-700 relative overflow-hidden">
        <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
        <div className="flex justify-between items-start">
          <div>
            <div className="flex items-center gap-2 mb-2">
               <Sparkles size={14} className="text-indigo-500" />
               <span className="text-xs font-bold text-indigo-500 uppercase tracking-wider">AI Mimic</span>
            </div>
            <p className="text-lg text-slate-700 dark:text-slate-200 font-medium">
              "{data.mimic}"
            </p>
          </div>
          <button 
            onClick={() => setIsExpanded(!isExpanded)}
            className="text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors p-1"
            title="æŸ¥çœ‹è¯æ±‡æ˜ å°„"
          >
            {isExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
          </button>
        </div>

        {/* è¯æ±‡æ˜ å°„ (æŠ˜å åŒºåŸŸ) */}
        {isExpanded && (
          <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 animate-in slide-in-from-top-2">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              {data.mapping.map((item, idx) => (
                <div key={idx} className="flex items-center gap-2 text-sm bg-slate-50 dark:bg-slate-900/50 p-2 rounded border border-slate-200 dark:border-slate-700">
                  <span className="text-slate-500 dark:text-slate-400">{item.from}</span>
                  <ArrowRight size={12} className="text-slate-300 dark:text-slate-600" />
                  <span className="font-semibold text-indigo-600 dark:text-indigo-400">{item.to}</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* 3. User Practice Area (Interactive) */}
      <div className="p-6 bg-white dark:bg-slate-800">
        <div className="flex items-center gap-2 mb-3">
          <PenTool size={14} className="text-emerald-500" />
          <span className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Your Practice</span>
        </div>
        
        <div className="space-y-3">
          {userInputs.map((input, idx) => (
            <div key={idx} className="relative group/input animate-in fade-in slide-in-from-bottom-2">
              <input
                type="text"
                value={input}
                onChange={(e) => handleInputChange(idx, e.target.value)}
                placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„æ¨¡ä»¿å¥å­..."
                className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg pl-4 pr-10 py-3 text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all placeholder:text-slate-400"
              />
              <div className="absolute right-3 top-3 opacity-0 group-focus-within/input:opacity-100 transition-opacity">
                {input.length > 0 ? <Check size={18} className="text-emerald-500" /> : <span className="w-4"></span>}
              </div>
            </div>
          ))}
          
          <button 
            onClick={handleAddInput}
            className="flex items-center gap-2 text-sm text-slate-500 hover:text-emerald-600 dark:text-slate-400 dark:hover:text-emerald-400 font-medium px-2 py-1 rounded-md hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
          >
            <Plus size={16} />
            <span>æ·»åŠ å¦ä¸€å¥æ¨¡ä»¿</span>
          </button>
        </div>
      </div>
    </section>
  );
};

// ä»»åŠ¡é¢„è§ˆé¡µ (Task Preview)
const PreviewPage = ({ selectedTalksData, onStartLearning }) => {
  const [activePreviewId, setActivePreviewId] = useState(selectedTalksData[0]?.id);
  const activeTalk = selectedTalksData.find(t => t.id === activePreviewId) || selectedTalksData[0];

  return (
    <div className="max-w-6xl mx-auto px-4 py-8 pb-24 h-full flex flex-col">
      <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
        <Layout className="text-indigo-600" /> 
        å­¦ä¹ ä»»åŠ¡é¢„è§ˆ ({selectedTalksData.length})
      </h2>
      
      <div className="flex flex-col lg:flex-row gap-8 flex-1">
        {/* å·¦ä¾§ï¼šæ¼”è®²åˆ—è¡¨ */}
        <div className="w-full lg:w-1/3 space-y-3">
          {selectedTalksData.map(talk => (
            <div 
              key={talk.id}
              onClick={() => setActivePreviewId(talk.id)}
              className={`p-4 rounded-xl cursor-pointer border transition-all ${
                activePreviewId === talk.id 
                  ? 'bg-white dark:bg-slate-800 border-indigo-500 shadow-md ring-1 ring-indigo-500/50' 
                  : 'bg-white/50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 hover:border-indigo-300'
              }`}
            >
              <h3 className={`font-bold text-sm mb-1 ${activePreviewId === talk.id ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-700 dark:text-slate-300'}`}>
                {talk.title}
              </h3>
              <p className="text-xs text-slate-500 dark:text-slate-500 line-clamp-1">{talk.speaker}</p>
            </div>
          ))}
        </div>

        {/* å³ä¾§ï¼šé¢„è§ˆè¯¦æƒ… & å¼€å§‹æŒ‰é’® */}
        <div className="w-full lg:w-2/3 bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-8 shadow-sm flex flex-col">
           <div className="flex-1">
              <div className="flex items-center gap-3 mb-4">
                 <div className={`w-12 h-12 rounded-full flex items-center justify-center ${activeTalk.thumbnail} text-indigo-600`}>
                    <Play size={20} fill="currentColor" />
                 </div>
                 <div>
                    <h3 className="text-xl font-bold text-slate-900 dark:text-white">{activeTalk.title}</h3>
                    <p className="text-slate-500 text-sm">{activeTalk.speaker} â€¢ {activeTalk.duration}</p>
                 </div>
              </div>
              <p className="text-slate-600 dark:text-slate-300 mb-6 leading-relaxed">
                {activeTalk.description}
              </p>
              
              <div className="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-5 border border-slate-100 dark:border-slate-700">
                <h4 className="font-bold text-slate-700 dark:text-slate-300 text-sm mb-3 flex items-center gap-2">
                   <Zap size={16} className="text-amber-500" /> 
                   ç”Ÿæˆå†…å®¹é¢„è§ˆ
                </h4>
                <div className="space-y-3">
                   <div className="h-2 w-3/4 bg-slate-200 dark:bg-slate-700 rounded animate-pulse"></div>
                   <div className="h-2 w-full bg-slate-200 dark:bg-slate-700 rounded animate-pulse"></div>
                   <div className="h-2 w-5/6 bg-slate-200 dark:bg-slate-700 rounded animate-pulse"></div>
                </div>
                <p className="text-xs text-slate-400 mt-4 text-center">åŒ…å«çº¦ 15 ä¸ªå½±å­å†™ä½œç»ƒä¹ å•å…ƒ</p>
              </div>
           </div>

           <div className="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 flex justify-end">
              <button 
                onClick={() => onStartLearning(activeTalk)}
                className="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all flex items-center gap-2 transform hover:scale-105"
              >
                <BookOpen size={20} />
                è¿›å…¥å­¦ä¹ ç•Œé¢
              </button>
           </div>
        </div>
      </div>
    </div>
  );
};

// æ²‰æµ¸å¼å­¦ä¹ ç•Œé¢ (Actual Learning Session)
const LearningSessionPage = ({ talk, onBack }) => {
  const content = MOCK_SHADOW_CONTENT[1] || []; // é»˜è®¤ä½¿ç”¨ ID 1 çš„æ•°æ®ä½œä¸ºæ¼”ç¤º

  return (
    <div className="max-w-4xl mx-auto px-4 py-8 pb-32">
       {/* é¡¶éƒ¨å¯¼èˆª */}
       <div className="sticky top-0 z-10 bg-slate-50/90 dark:bg-slate-950/90 backdrop-blur-md py-4 mb-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
          <button onClick={onBack} className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-white transition-colors">
             <ArrowRight className="rotate-180" size={20} />
             <span className="font-medium hidden sm:inline">è¿”å›ä»»åŠ¡åˆ—è¡¨</span>
          </button>
          <div className="text-center">
             <h2 className="text-sm font-bold text-slate-900 dark:text-white line-clamp-1">{talk.title}</h2>
             <p className="text-xs text-slate-500">2 / 15 å®Œæˆ</p>
          </div>
          <button className="text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
             <MoreHorizontal size={24} />
          </button>
       </div>

       {/* ç»ƒä¹ å¡ç‰‡åˆ—è¡¨ */}
       <div className="space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-500">
          {content.map((item, index) => (
             <div key={item.id}>
                <div className="flex items-center gap-4 mb-4">
                   <div className="h-[1px] flex-1 bg-slate-200 dark:bg-slate-800"></div>
                   <span className="text-xs font-bold text-slate-400">ç»ƒä¹  {index + 1}</span>
                   <div className="h-[1px] flex-1 bg-slate-200 dark:bg-slate-800"></div>
                </div>
                <LearningCard data={item} />
             </div>
          ))}

          <div className="text-center pt-10 pb-20">
             <button className="bg-slate-900 dark:bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all hover:-translate-y-1">
                å®Œæˆæœ¬èŠ‚ç»ƒä¹  ğŸ‰
             </button>
          </div>
       </div>
    </div>
  );
};

/**
 * ------------------------------------------------------------------
 * é¡µé¢çº§ç»„ä»¶ (Page Components)
 * ------------------------------------------------------------------
 */

const HistoryPage = ({ onNavigateToLearning }) => {
  const [activeTab, setActiveTab] = useState('todo'); // todo, in_progress, completed

  const filteredHistory = MOCK_HISTORY.filter(item => item.status === activeTab);

  const tabs = [
    { id: 'todo', label: 'å¾…å­¦ä¹ ', icon: Clock, color: 'text-amber-500' },
    { id: 'in_progress', label: 'å­¦ä¹ ä¸­', icon: Zap, color: 'text-indigo-500' },
    { id: 'completed', label: 'å·²å®Œæˆ', icon: CheckCircle, color: 'text-emerald-500' },
  ];

  return (
    <div className="max-w-5xl mx-auto px-4 py-8 animate-in fade-in slide-in-from-bottom-4 pb-24 md:pb-8">
      <h1 className="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white mb-8">å­¦ä¹ å†å²</h1>
      
      {/* Tabs */}
      <div className="flex gap-2 mb-8 bg-slate-100 dark:bg-slate-800/50 p-1.5 rounded-xl w-full sm:w-auto inline-flex">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex-1 sm:flex-none px-6 py-2.5 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${
              activeTab === tab.id 
                ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' 
                : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'
            }`}
          >
            <tab.icon size={16} className={activeTab === tab.id ? tab.color : ''} />
            {tab.label}
            <span className="ml-1 text-xs opacity-60 bg-slate-100 dark:bg-slate-800 px-1.5 rounded-full">
              {MOCK_HISTORY.filter(h => h.status === tab.id).length}
            </span>
          </button>
        ))}
      </div>

      {/* List */}
      <div className="grid grid-cols-1 gap-4">
        {filteredHistory.length > 0 ? (
          filteredHistory.map((item) => {
            const talk = MOCK_TED_TALKS.find(t => t.id === item.talkId) || MOCK_TED_TALKS[0];
            return (
              <div 
                key={item.id} 
                onClick={() => onNavigateToLearning(talk)}
                className="group bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md hover:border-indigo-300 dark:hover:border-indigo-500 transition-all cursor-pointer flex items-center gap-5"
              >
                {/* Thumbnail / Status Icon */}
                <div className={`w-16 h-16 rounded-xl flex items-center justify-center shrink-0 ${
                   activeTab === 'completed' ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-400' :
                   activeTab === 'in_progress' ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400' :
                   'bg-amber-100 text-amber-600 dark:bg-amber-900/20 dark:text-amber-400'
                }`}>
                   {activeTab === 'completed' ? <CheckCircle size={28} /> : 
                    activeTab === 'in_progress' ? <Play size={28} fill="currentColor" /> : 
                    <Clock size={28} />}
                </div>

                <div className="flex-1 min-w-0">
                  <h3 className="font-bold text-lg text-slate-900 dark:text-white truncate group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                    {item.title}
                  </h3>
                  <div className="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 mt-1">
                    <span>{talk.speaker}</span>
                    <span>â€¢</span>
                    <span>{item.lastPlayed}</span>
                  </div>
                  
                  {/* Progress Bar (Only for In Progress) */}
                  {activeTab === 'in_progress' && (
                    <div className="mt-3 w-full max-w-xs h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                       <div className="h-full bg-indigo-500 rounded-full" style={{width: `${item.progress}%`}}></div>
                    </div>
                  )}
                </div>

                <div className="hidden sm:flex items-center justify-center w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white transition-all">
                   <ArrowRight size={20} />
                </div>
              </div>
            );
          })
        ) : (
          <div className="text-center py-20 bg-white dark:bg-slate-800 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700">
             <div className="w-16 h-16 bg-slate-100 dark:bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                <List size={32} />
             </div>
             <p className="text-slate-500 dark:text-slate-400">æš‚æ— æ­¤çŠ¶æ€çš„è®°å½•</p>
          </div>
        )}
      </div>
    </div>
  );
};

// æœç´¢è¾“å…¥ç»„ä»¶ (from prev)
const SearchInput = ({ onSearch, isSearching }) => {
  const [query, setQuery] = useState('');
  const handleSubmit = (e) => { e.preventDefault(); if (query.trim()) onSearch(query); };

  return (
    <div className="w-full max-w-3xl mx-auto">
      <form onSubmit={handleSubmit} className="relative group" role="search">
        <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
          {isSearching ? (
            <div className="animate-spin rounded-full h-5 w-5 border-2 border-indigo-500 border-t-transparent"></div>
          ) : (
            <Search className="h-5 w-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors" />
          )}
        </div>
        <input
          type="text"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="è¾“å…¥å­¦ä¹ ä¸»é¢˜ï¼Œä¾‹å¦‚ 'AI Ethics'..."
          className="w-full pl-12 pr-4 py-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all text-lg placeholder:text-slate-400 dark:placeholder:text-slate-500 text-slate-900 dark:text-white"
        />
        <button 
          type="submit"
          className="absolute right-2 top-2 bottom-2 bg-slate-900 dark:bg-indigo-600 text-white px-4 rounded-xl font-medium hover:bg-slate-800 dark:hover:bg-indigo-700 transition-colors disabled:opacity-50"
          disabled={!query.trim() || isSearching}
        >
          <span className="hidden sm:inline">å¼€å§‹æ¢ç´¢</span>
          <ArrowRight className="sm:hidden" size={20} />
        </button>
      </form>
      <div className="mt-3 flex flex-wrap gap-2 justify-center text-sm text-slate-500 dark:text-slate-400">
        <span>çƒ­é—¨æœç´¢:</span>
        {["Public Speaking", "Technology", "Psychology"].map(tag => (
          <button key={tag} onClick={() => setQuery(tag)} className="hover:text-indigo-600 dark:hover:text-indigo-400 underline decoration-dotted transition-colors">{tag}</button>
        ))}
      </div>
    </div>
  );
};

// TED åˆ—è¡¨ç»„ä»¶ (from prev)
const TedCard = ({ talk, isSelected, onToggle }) => {
  return (
    <article 
      onClick={() => onToggle(talk.id)}
      className={`relative group cursor-pointer bg-white dark:bg-slate-800 rounded-2xl overflow-hidden border transition-all duration-300 flex flex-col h-full ${
        isSelected 
          ? 'border-indigo-500 ring-2 ring-indigo-500/20 shadow-lg translate-y-[-2px]' 
          : 'border-slate-200 dark:border-slate-700 hover:border-indigo-300 dark:hover:border-indigo-500/50 hover:shadow-md'
      }`}
    >
      <div className={`h-36 sm:h-40 ${talk.thumbnail} flex items-center justify-center relative overflow-hidden`}>
        <div className="absolute inset-0 bg-black/5 dark:bg-black/20 group-hover:bg-transparent transition-colors"></div>
        <div className="w-12 h-12 bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center z-10 shadow-lg group-hover:scale-110 transition-transform">
          <Play className="text-slate-900 fill-slate-900 ml-1" size={20} />
        </div>
        <div className="absolute bottom-2 right-2 bg-black/70 backdrop-blur-sm text-white text-xs font-bold px-2 py-1 rounded">{talk.duration}</div>
      </div>
      
      <div className="p-4 flex flex-col flex-1">
        <div className="flex justify-between items-start mb-2">
          <h3 className="font-bold text-slate-900 dark:text-white line-clamp-2 leading-tight text-base">{talk.title}</h3>
          {isSelected && <CheckCircle className="text-indigo-600 dark:text-indigo-400 flex-shrink-0 ml-2 animate-in zoom-in" size={20} />}
        </div>
        <p className="text-sm text-indigo-600 dark:text-indigo-400 font-medium mb-2">{talk.speaker}</p>
        <p className="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 mb-4 flex-1">{talk.description}</p>
      </div>
    </article>
  );
};

// å¤„ç†ä¸­é¡µé¢
const ProcessingPage = ({ onFinish }) => {
  const [progress, setProgress] = useState(0);
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    let currentProgress = 0;
    const interval = setInterval(() => {
      currentProgress += Math.random() * 8;
      if (currentProgress > 100) {
        currentProgress = 100;
        clearInterval(interval);
        setTimeout(onFinish, 500); // å®Œæˆåè·³è½¬
      }
      setProgress(Math.min(currentProgress, 100));
      
      if (Math.random() > 0.8) {
        const newLog = ["è¯­ä¹‰åˆ†å—å¤„ç†...", "åˆ†æè¯­è¨€ç»“æ„...", "ç”Ÿæˆè¯é¢˜è¿ç§»...", "è´¨é‡æ ¡éªŒ..."][Math.floor(Math.random() * 4)];
        setLogs(prev => [newLog, ...prev].slice(0, 1));
      }
    }, 200);
    return () => clearInterval(interval);
  }, [onFinish]);

  return (
    <div className="max-w-xl mx-auto px-4 py-20 text-center">
      <div className="relative w-40 h-40 mx-auto mb-8">
          <svg className="w-full h-full transform -rotate-90">
            <circle cx="80" cy="80" r="70" stroke="#e2e8f0" strokeWidth="8" fill="none" className="dark:stroke-slate-700" />
            <circle 
              cx="80" cy="80" r="70" stroke="#6366f1" strokeWidth="8" fill="none" 
              strokeDasharray={440}
              strokeDashoffset={440 - (440 * progress) / 100}
              className="transition-all duration-200 ease-out"
            />
          </svg>
          <div className="absolute inset-0 flex items-center justify-center flex-col">
             <span className="text-3xl font-bold text-slate-800 dark:text-white">{Math.round(progress)}%</span>
          </div>
      </div>
      <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">æ­£åœ¨ç”Ÿæˆå­¦ä¹ å†…å®¹</h3>
      <p className="text-slate-500 h-6">{logs[0] || "åˆå§‹åŒ–å¼•æ“..."}</p>
    </div>
  );
};

const SettingsPage = ({ isDarkMode, toggleTheme }) => {
  return (
    <div className="max-w-3xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-8 dark:text-white">ç³»ç»Ÿè®¾ç½®</h1>
      <div className="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
         <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className={`p-2 rounded-lg ${isDarkMode ? 'bg-indigo-900/30 text-indigo-400' : 'bg-orange-100 text-orange-500'}`}>
                {isDarkMode ? <Moon size={20} /> : <Sun size={20} />}
              </div>
              <span className="dark:text-white">ç•Œé¢å¤–è§‚</span>
            </div>
            <button onClick={toggleTheme} className={`w-12 h-6 rounded-full p-1 transition-colors ${isDarkMode ? 'bg-indigo-600' : 'bg-slate-200'}`}>
              <div className={`w-4 h-4 bg-white rounded-full transition-transform ${isDarkMode ? 'translate-x-6' : ''}`}></div>
            </button>
         </div>
      </div>
    </div>
  );
};

const StatsPage = () => (
    <div className="max-w-5xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-8 dark:text-white">æ•°æ®ç»Ÿè®¡</h1>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
             <p className="text-slate-500">æ€»æ—¶é•¿</p>
             <p className="text-2xl font-bold dark:text-white">12.5 h</p>
          </div>
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700">
             <p className="text-slate-500">ç»ƒä¹ å¥å­</p>
             <p className="text-2xl font-bold dark:text-white">342</p>
          </div>
      </div>
    </div>
);

// æœç´¢ä¸»é¡µ
const ChatPage = ({ onStartProcessing }) => {
  const [searchStatus, setSearchStatus] = useState('idle');
  const [selectedTalks, setSelectedTalks] = useState([]);

  const handleSearch = (query) => {
    setSearchStatus('searching');
    setTimeout(() => setSearchStatus('results'), 1000);
  };

  const toggleTalk = (id) => {
    if (selectedTalks.includes(id)) {
      setSelectedTalks(selectedTalks.filter(tid => tid !== id));
    } else {
      setSelectedTalks([...selectedTalks, id]);
    }
  };

  const startBatch = () => {
    // å°†é€‰ä¸­çš„ ID è½¬æ¢ä¸ºå®Œæ•´çš„ Talk å¯¹è±¡ä¼ é€’ç»™å¤„ç†æµç¨‹
    const talksToProcess = MOCK_TED_TALKS.filter(t => selectedTalks.includes(t.id));
    onStartProcessing(talksToProcess);
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 pb-24 md:pb-8">
      <div className={`transition-all duration-500 ${searchStatus === 'idle' ? 'mt-20' : 'mt-0'}`}>
        <div className="text-center mb-10">
          <h1 className="text-3xl sm:text-5xl font-extrabold text-slate-900 dark:text-white mb-4 tracking-tight">
            Shadow Writing <span className="text-indigo-600 dark:text-indigo-400">Mastery</span>
          </h1>
          <p className="text-slate-500 dark:text-slate-400 max-w-2xl mx-auto">AI é©±åŠ¨çš„ TED æ¼”è®²æ·±åº¦æ¨¡ä»¿å­¦ä¹ ç³»ç»Ÿ</p>
        </div>
        <SearchInput onSearch={handleSearch} isSearching={searchStatus === 'searching'} />
      </div>

      {searchStatus === 'results' && (
        <div className="mt-12 animate-in fade-in slide-in-from-bottom-8">
          <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
              <Library className="text-indigo-500" /> æ¨èæ¼”è®²
            </h2>
            {selectedTalks.length > 0 && (
               <button 
                onClick={startBatch}
                className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium shadow-md transition-all flex items-center gap-2 animate-in fade-in"
               >
                 <Zap size={18} />
                 å¼€å§‹å¤„ç† ({selectedTalks.length})
               </button>
            )}
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {MOCK_TED_TALKS.map(talk => (
              <TedCard key={talk.id} talk={talk} isSelected={selectedTalks.includes(talk.id)} onToggle={toggleTalk} />
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// --- Main App Component ---

const ShadowWritingApp = () => {
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [authStatus, setAuthStatus] = useState('logged_out');
  const [activeTab, setActiveTab] = useState('chat');
  
  // App State Machine
  // idle -> processing -> preview -> learning
  const [appState, setAppState] = useState('idle'); 
  const [processedTalks, setProcessedTalks] = useState([]); // å­˜å‚¨é€‰ä¸­çš„æ¼”è®²æ•°æ®
  const [currentLearningTalk, setCurrentLearningTalk] = useState(null); // å½“å‰æ­£åœ¨å­¦ä¹ çš„æ¼”è®²

  useEffect(() => {
    document.documentElement.classList.toggle('dark', isDarkMode);
  }, [isDarkMode]);

  // Handlers
  const handleStartProcessing = (talks) => {
    setProcessedTalks(talks);
    setAppState('processing');
  };

  const handleProcessingFinish = () => {
    setAppState('preview');
  };

  const handleStartLearning = (talk) => {
    setCurrentLearningTalk(talk);
    setAppState('learning');
  };

  const handleNavigateFromHistory = (talk) => {
    setActiveTab('chat');
    setCurrentLearningTalk(talk);
    setAppState('learning');
  };

  const handleLogout = () => {
    setAuthStatus('logged_out');
    setAppState('idle');
    setActiveTab('chat');
  };

  const renderChatContent = () => {
    switch (appState) {
      case 'idle':
        return <ChatPage onStartProcessing={handleStartProcessing} />;
      case 'processing':
        return <ProcessingPage onFinish={handleProcessingFinish} />;
      case 'preview':
        return <PreviewPage selectedTalksData={processedTalks} onStartLearning={handleStartLearning} />;
      case 'learning':
        return <LearningSessionPage talk={currentLearningTalk} onBack={() => setAppState('preview')} />;
      default:
        return <ChatPage onStartProcessing={handleStartProcessing} />;
    }
  };

  if (authStatus === 'logged_out') return <LoginPage onLogin={() => setAuthStatus('user')} onGuest={() => setAuthStatus('guest')} />;

  return (
    <div className={`flex h-screen font-sans overflow-hidden transition-colors duration-300 ${isDarkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900'}`}>
      <Navigation 
        activeTab={activeTab} 
        setActiveTab={(tab) => {
          setActiveTab(tab);
          if (tab !== 'chat') setAppState('idle'); // åˆ‡æ¢ Tab æ—¶é‡ç½®èŠå¤©çŠ¶æ€ï¼Œé™¤éä½ æƒ³ä¿ç•™
        }}
        userMode={authStatus}
        onLogout={handleLogout}
      />
      <main className="flex-1 overflow-y-auto scroll-smooth w-full relative">
        {activeTab === 'chat' && renderChatContent()}
        {activeTab === 'history' && <HistoryPage onNavigateToLearning={handleNavigateFromHistory} />}
        {activeTab === 'stats' && <StatsPage />}
        {activeTab === 'settings' && <SettingsPage isDarkMode={isDarkMode} toggleTheme={() => setIsDarkMode(!isDarkMode)} />}
      </main>
    </div>
  );
};

export default ShadowWritingApp;